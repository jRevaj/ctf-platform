{% extends 'base.html' %}

{% block content %}
<div class="container">
    {% if user.is_authenticated and user.team and active_assignments %}
        <h2 class="mb-4">Aktívne výzvy</h2>
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            {% for assignment in active_assignments %}
                <div class="col">
                    <div class="card h-100 border-5 {% if assignment.role == 'RED' %}border-danger{% else %}border-primary{% endif %}">
                        <div class="card-body">
                            <h5 class="card-title">{{ assignment.deployment.template.name }}</h5>
                            <p class="card-text text-muted">
                                Fáza končí: {{ assignment.end_date|date:"d.m.Y H:i" }}
                            </p>
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                                    data-bs-target="#assignmentModal{{ assignment.id }}">
                                Zobraziť detaily
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Modal for each assignment -->
                <div class="modal fade" id="assignmentModal{{ assignment.id }}" tabindex="-1"
                     aria-labelledby="assignmentModalLabel{{ assignment.id }}" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="assignmentModalLabel{{ assignment.id }}">
                                    {{ assignment.deployment.template.name }}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                {% for container in assignment.deployment.containers.all %}
                                    {% if container.is_entrypoint %}
                                        <div class="mb-4">
                                            <h6 class="mb-3">Informácie o pripojení</h6>
                                            <div class="input-group">
                                                <input type="text" class="form-control"
                                                       value="{{ container.connection_string }}"
                                                       readonly>
                                                <button class="btn btn-outline-secondary" type="button"
                                                        data-bs-toggle="tooltip"
                                                        title="Kopírovať do schránky"
                                                        onclick="copyToClipboard('{{ container.connection_string }}', 'connectionToast')">
                                                    <i class="bi bi-clipboard"></i>
                                                </button>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endfor %}

                                {% if assignment.role == 'RED' %}
                                    <hr>
                                    <h6>Odoslať flag</h6>
                                    <form id="flagForm{{ assignment.id }}" class="flag-submit-form">
                                        {% csrf_token %}
                                        <div class="mb-3">
                                            <label for="flagValue{{ assignment.id }}" class="form-label">Hodnota flagu</label>
                                            <input type="text" class="form-control"
                                                   id="flagValue{{ assignment.id }}" name="flag" required>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Odoslať</button>
                                    </form>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>

        <!-- Toast notification -->
        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div id="connectionToast" class="toast align-items-center text-bg-success border-0" role="alert"
                 aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="bi bi-check-circle me-2"></i>Pripojovací reťazec skopírovaný do schránky!
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                            aria-label="Close"></button>
                </div>
            </div>
        </div>
    {% endif %}
</div>

{% if user.is_authenticated %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Handle flag submission
        document.querySelectorAll('.flag-submit-form').forEach(form => {
            form.addEventListener('submit', function (e) {
                e.preventDefault();
                const formData = new FormData(this);
                const assignmentId = this.id.replace('flagForm', '');
                
                fetch('/api/flags/submit/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Flag úspešne odoslaný!');
                        this.reset();
                    } else {
                        alert('Neplatný flag!');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Pri odosielaní flagu nastala chyba.');
                });
            });
        });
    });

    function copyToClipboard(text, toastId) {
        navigator.clipboard.writeText(text).then(function () {
            const toast = new bootstrap.Toast(document.getElementById(toastId));
            toast.show();

            const tooltip = bootstrap.Tooltip.getInstance(
                document.querySelector('[data-bs-toggle="tooltip"]')
            );
            if (tooltip) {
                tooltip.hide();
            }
        });
    }
</script>
{% endif %}
{% endblock %} 